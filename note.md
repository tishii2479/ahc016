# 全体を通して

- 方針は固めすぎない
    - 実装しすぎない
    - 思い込みをなくす
- 少しずつ改善する
- 何か問題特有のヒューリスティックは必要
    - ボトムアップに考える
    - 問題の観察を丁寧にする
- 貪欲の質を上げる

# 11/11

「次数列の復元 + グラフ構造を使ったヒューリスティック」がテーマっぽい

- 次数列の復元
    - 次数列の距離
- グラフ構造を使ったヒューリスティック
    - 連結成分の個数
    - 二部グラフ
    - ウニ
- M, epsが大きいときはNを大きめにする必要がありそう
- ある程度グラフを作ったら辺の接続を入れ替える焼きなまし?
- グラフ同士の距離が遠くなるように
- クエリのグラフからシミュレーションして、一番確率が高いグラフを出力

- M、epsごとに埋め込みができる
    - グラフの情報は整数で埋め込みできる

- 次数列の距離
    - 次数列をソートした時の各要素の差の二乗和
        ```
        d(0122, 0013) = 0 + 1 + 1 + 1 = 3
        ```
    - 必要な操作の最小か平均回数
- 次数列からグラフ構築
    - Havel-Hakimi
        - `O(N^2 log N)`
    - 普通にグラフから次数列を作るで良い
        - ソートで`O(N log N)`

- 復元方法
    - シミュレーションした結果、次数列の距離が最小なものを探す
        - epsが大きい時に厳しそう
    - シミュレーションし直すのか、二乗和を考えるだけ?
        - 実行時間5秒あるし、何かしらしそう
        - 必要な操作の最小か平均回数を求める

- 事前分布をなるべく離す
    - 辺の総数をなるべく離す
        - 等間隔でいいのか、次数列の分布を考えると不均一かも
    - 二項分布
        - `M = N * (N - 1) / 2`
        - `S = 元の辺の総数`
        - `T = 操作後の辺の総数`
        ```
        E(T | S, eps)
            = S * (1 - eps) + (M - S) * eps
            = S + (M - 2 * S) * eps
            = S * (1 - 2 * eps) + M * eps

        eps = 0     ->   1 * S
        eps = 0.4   -> 0.2 * S + 0.4 * M
        eps = 0.5   ->           0.5 * M
        ```
        - ランダムウォーク、マルコフ連鎖
        - `TODO:` ちゃんと確率分布`P(T | S, eps)`を考える
            - 周辺化で解けそう
- 次数の分布
    - 離した方がいいのか、一緒の方がいいのか
        - 他のサイズのグラフによる
            - ここが焼けそうな気がする
            - でも埋め込めるんだよな
        ```
        a = 4 1 1 1 1 0 0 0
        b = 2 2 2 2 0 0 0 0
        c = 7 1 1 1 1 1 1 1
        d = 2 2 2 2 2 2 2 0

        e = 2 2 2 2 2 0 0 0
        f = 5 1 1 1 1 1 0 0

        s(a) = s(b) = 8
        s(c) = s(d) = 14
        s(e) = 10

        d(a, e) = 8
        d(d, e) = 8
        ```
        - `TODO:` 本質は何か
- サイズ以外でグラフの距離を決めるのは
    - 次数の分布
        - `TODO:` 実験して確かめる
    - 辺の接続の仕方は関係あるか
        - 同じ次数列でも違うグラフがある
        - 関係ありそう
            - 辺の接続が切り替わった時の次数列の変化がグラフによって変わるため
        - 関係あるなら、辺の接続は隣接行列で持つ必要がある
- 高速化
    - あらかじめ作ったmaskでxorをとる

# 11/12

- 橋の数は使えそう
    - 削除と追加が同じ確率で行われるので、そこまでかも
- グラフの距離は必要な操作の最小か平均回数
    - 頂点番号がないので、厳密に求めるのは難しい

## 方針

### 1. なるべく離れた位置にあるグラフを構築する

1. M個のグラフをランダムに初期化する
2. 隣接するグラフの距離が遠くなるように焼く
    - 辺の接続を入れ替える
    - 辺の接続先を変更する
3. 構築したグラフを出力する

### 2. クエリを受け取って復元する　

1. グラフを受け取る
2. 受け取ったグラフと構築したグラフの距離を求め、最も近いグラフを出力する

### 必要な要素

- グラフの距離の正確な定義
    - グラフの類似度を測る手法
    - 辺の削除、追加の必要回数
        - グラフ編集距離（Graph Edit Distance）の辺だけ
    - グラフの編集距離を求める問題はNP-Hard
        - 頂点をどう対応させるか（ノードマッピング）をA*アルゴリズムを使って最適化するとある程度のサイズまで解けるらしい
            - https://proceedings-of-deim.github.io/DEIM2022/papers/I44-1.pdf

- 頂点番号の対応付けを行うと、編集距離は計算できる
    - 対応付けを最適化して、編集距離を最小にした時の値を使う
        - 焼きなまし
            - 2頂点をswap
            - 遅い
        - ビームサーチ
            - 構築するときはこっち?
            - 早い
        - ある程度の貪欲

- M個のグラフの構築は工夫が必要
    - 全体の距離を考慮した評価関数を考える必要がある
- 復元するときには辺の追加、削除は考える必要がある

## 今後の方針

1. 構築
2. 復元

- 復元
    - Mが大きくても、最初に辺の総数によってある程度絞り込める
    - 難しい問題ほど時間を多く取る

# 11/13

類似度をより正確に、高速に求める

- ビームサーチで初期解を作る
- 編集距離の近似手法が必要かも

- グラフ生成の評価関数をminではなく総和に
    - 近い値を重視するために、距離の0.5乗を使う

- 辺の総数の平均の変化を考慮する必要がある
    - 特にepsが大きいとき
        -　辺の総数は `N * (N - 1) / 2` に近づく
    - グラフの単純な類似度だけだと、epsが大きい時に駄目

- epsが大きい時の対策を考える
    - 何回かシミュレーションして、その後類似度を求める
        - 相当良い
- m, epsが小さいときは強い

```
N = 30
ave: 6509895.81
err ave: 46.21
         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |  44859999   26919002    8708427    3506621    6348444    1549501      24174      74430
   40~70 |  16277643    7419666    2225835     336712      63930      22186       8730       6471
  70~100 |  12251409    1337414     364372     130049      12719       6437       2570       2233
```

- 埋め込みはNの値だけしか無理そう
    - ファイルサイズは 512 KiB
    - 構築は後でやる必要がありそう
- 構築と復元の時間管理が必要
- Nの調整は結構大変

### 改善点

- epsが大きい時をもう少しまともに考える
- グラフの構築
    - 次数列の分布を考慮する
- グラフの類似度の求め方
    - 次数列の分布の類似度

### 現状の解法の整理

1. グラフの構築
    1. i番目に構築するグラフの辺の総数を`N * (N - 1) / 2 / (M - 1) * i`として、順番に頂点に辺を足す
2. グラフの復元
    1. 構築したグラフをモンテカルロでシミュレーションして、受け取ったグラフとの類似度を求める
        - 辺の総数が違いすぎるグラフはあらかじめ弾いている

### 改善点

- 類似度の求め方
    - 近い辺の数を持つグラフは構造で区別する
    - やはりグラフの構造を使いたい
        - 連結成分の個数、連結成分のサイズ
    - これを考慮したグラフの構築をする
- 他の復元方法の模索
- Nの最適化はしばらくしない

- 辺の総数を等間隔にしている
    - 最後の方が間違えやすいかも
- 辺の総数が隣のグラフに間違えることが多い
    - 隣のグラフと構造的に違いを作る
        - 次数列の分布の違い
            ```
            ooooo
            o
            o
            ooooo
            ```
            と
            ```
            o
            ooooo
            o
            ```
        - 連結成分のサイズ
            ```
            9 1 1 ... 1 0 ... 0 0
            3 3 ... 3 2 ... 2 2 1
            ```

### 研究テーマ

ノイズに強いグラフとは

### スコア観察

- epsが大きいときにちょっとスコアが下がってるかも
    - サンプル少ないだけ?

```
commit: 5616046
ave: 13615107.34
err ave: 8.22
         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |  39500000   19027778   16666667   16190476   15833333   13490538    7233798    5806960
   40~70 |  32154672   20138889   11666666    9620000    9500000    8113180    3811784    1631015
  70~100 |  24687500   15055555   10357142    8840000    7860000    2839391     859418      46886
-------------------------------------------------------------------------------------------------

         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |      0.20       0.17       0.00       0.29       0.50       2.50       4.40       9.00
   40~70 |      1.10       0.33       0.33       0.40       0.50       2.20      12.50      18.67
  70~100 |      0.12       1.00       0.43       1.20       2.33      15.00      24.50      60.57
-------------------------------------------------------------------------------------------------

commit: c76d0ee
ave: 16098469.64
err ave: 8.92
         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |  46666666   27777777   22500000   19428571   19000000   12272512    5553155    5790968
   40~70 |  38447743   28194444   18416666    9800000    9500000    7978882    3797293    1841240
  70~100 |  32083333   14765901   11330165    9200000    8400000    3041891     938642      39552
-------------------------------------------------------------------------------------------------

         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |      0.00       0.00       0.00       0.29       0.50       9.00       9.00       9.00
   40~70 |      1.30       0.33       0.67       0.20       0.50       2.40      12.33      17.67
  70~100 |      0.38       5.33       5.43       0.80       1.67      14.75      24.33      59.43
-------------------------------------------------------------------------------------------------

commit: 71b1abb
ave: 16178182.87
err ave: 8.9
         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |  46666666   27777777   22500000   19428571   19000000   12677449    5872074    5785518
   40~70 |  38447743   28194444   18416666    9800000    9000000    7888793    3642909    1933536
  70~100 |  32916666   14407179   11410748    9200000    8130000    2940202     796059      44256
-------------------------------------------------------------------------------------------------

         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |      0.00       0.00       0.00       0.29       0.50       8.33       8.40       9.14
   40~70 |      1.30       0.33       0.67       0.20       1.00       2.60      12.83      17.67
  70~100 |      0.12       5.67       5.43       0.80       2.00      15.50      25.50      58.57
-------------------------------------------------------------------------------------------------

commit:
if eps <= 0.3 || m <= 40 { f1, f2, f3 } else { f3 }
ave: 16305794.89
err ave: 7.72
         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |  46666666   27777777   22500000   19714285   19000000   12749018    5897919    5785518
   40~70 |  38447743   28194444   18416666    9800000    9000000    8390200    4345421    2576736
  70~100 |  32916666   14407179   11535276    9200000    8400000    3209126     976265     108559
-------------------------------------------------------------------------------------------------

         |    0~0.05   0.05~0.1   0.1~0.15   0.15~0.2   0.2~0.25   0.25~0.3   0.3~0.35   0.35~0.4
-------------------------------------------------------------------------------------------------
   10~40 |      0.00       0.00       0.00       0.14       0.50       8.00       8.20       9.14
   40~70 |      1.30       0.33       0.67       0.20       1.00       1.80      11.17      15.00
  70~100 |      0.12       5.67       5.29       0.80       1.67      13.75      23.00      47.43
-------------------------------------------------------------------------------------------------
```

# 11/14

- 構築方法の模索
    - 次数列以外の類似度
    - 3つ目を作るか、類似度の計り方を工夫する
        - 難しいM, epsの時は3つ目があった方が良さそう
- 他の復元方法の模索
    - モンテカルロ以外

- 間違え方の集計をする
- 辺の総数の差は多分不均一が良い
    - 真ん中への近づき方が端っこの方が強い
    - **操作後の辺の総数を等間隔にしたい**
